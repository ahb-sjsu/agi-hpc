name: AGI-HPC CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:

  # ------------------------------------------------------------------
  # LINT + PROTO VALIDATION + TESTS
  # ------------------------------------------------------------------
  build:
    name: Lint, Generate Protos, Run Tests
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # Checkout the repo
      # -----------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # -----------------------------
      # Setup Python
      # -----------------------------
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # -----------------------------
      # Install dependencies
      # -----------------------------
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install grpcio grpcio-tools protobuf absl-py

      # -----------------------------
      # Validate proto headers
      # -----------------------------
      - name: Validate proto header syntax
        run: |
          python - << 'EOF'
          import pathlib, re, sys
          for f in pathlib.Path("proto").glob("*.proto"):
              txt = f.read_text()
              if 'syntax = "proto3";' not in txt:
                  print(f"[ERROR] Missing syntax in {f}")
                  sys.exit(1)
              if not re.search(r'^package\s+agi\.\w+\.v1;', txt, re.M):
                  print(f"[ERROR] Invalid or missing package declaration in {f}")
                  sys.exit(1)
          print("Proto header validation OK")
          EOF

      # -----------------------------
      # Regenerate proto stubs
      # -----------------------------
      - name: Generate Python GRPC stubs
        run: |
          python generate_protos.py --clean
          black src tests

      # -----------------------------
      # Validate TOML Syntax in GitHub Actions
      # -----------------------------
      - name: Validate pyproject.toml syntax (Taplo)
        run: |
          pip install taplo
          taplo lint pyproject.toml


      # -----------------------------
      # Lint (Black, isort, flake8)
      # -----------------------------
      - name: Lint source files
        run: |
          black --check src tests
          isort --check-only src tests
          flake8 src tests

      # -----------------------------
      # Run tests
      # -----------------------------
      - name: Run pytest
        run: |
          pytest -q --disable-warnings --maxfail=1

      # -----------------------------
      # Ensure no uncommitted changes exist post-generation
      # (Prevents devs from forgetting to commit generated stubs)
      # -----------------------------
      - name: Ensure working directory clean
        run: |
          if [ -n "$(git status --porcelain)" ]; then
              echo "ERROR: repo not clean after proto generation or testing!"
              echo "Diff:"
              git status
              git --no-pager diff
              exit 1
          fi
