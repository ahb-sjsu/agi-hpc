name: AGI-HPC CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: Lint, Generate Protos, Run Tests
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # Clean checkout (IMPORTANT!)
      # -----------------------------
      - name: Checkout
        uses: actions/checkout@v4
        with:
          clean: true
          fetch-depth: 0

      # -----------------------------
      # Setup Python
      # -----------------------------
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # -----------------------------
      # Install dependencies
      # -----------------------------
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # DO NOT install grpcio-tools here (it autogenerates files into src/)
          pip install -e ".[dev]"
          pip install protobuf absl-py

      # -----------------------------
      # Remove any auto-generated pb2 files
      # (grpcio-tools sometimes writes to src/)
      # -----------------------------
      - name: Clean stray proto files
        run: |
          find src -maxdepth 1 -name "*_pb2.py" -delete || true
          find src -maxdepth 1 -name "*_pb2_grpc.py" -delete || true

      # -----------------------------
      # Validate proto headers
      # -----------------------------
      - name: Validate proto header syntax
        run: |
          python - << 'EOF'
          import pathlib, re, sys
          for f in pathlib.Path("proto").glob("*.proto"):
              txt = f.read_text()
              if 'syntax = "proto3";' not in txt:
                  print(f"[ERROR] Missing syntax in {f}")
                  sys.exit(1)
              if not re.search(r'^package\s+agi\.\w+\.v1;', txt, re.M):
                  print(f"[ERROR] Invalid or missing package declaration in {f}")
                  sys.exit(1)
          print("Proto header validation OK")
          EOF

      # -----------------------------
      # Regenerate protobuf stubs
      # -----------------------------
      - name: Generate Python GRPC stubs
        run: |
          python generate_protos.py --clean

      # -----------------------------
      # Format generated code
      # -----------------------------
      - name: Apply Black formatting
        run: |
          black src tests

      # -----------------------------
      # Let Ruff autofix everything
      # -----------------------------
      - name: Auto-fix with Ruff
        run: |
          ruff check --fix src tests
        
      # -----------------------------
      # Validate TOML syntax
      # -----------------------------
      - name: Validate pyproject.toml syntax (Taplo)
        run: |
          pip install taplo
          taplo lint pyproject.toml

      # -----------------------------
      # Lint codebase
      # -----------------------------
      - name: Lint source files
        run: |
          black --check src tests
          ruff check src tests

      # -----------------------------
      # Run tests
      # -----------------------------
      - name: Run pytest
        run: |
          pytest -q --disable-warnings --maxfail=1

      # -----------------------------
      # Ensure working tree clean
      # -----------------------------
      - name: Ensure working directory clean
        run: |
          if [ -n "$(git status --porcelain)" ]; then
              echo "ERROR: repo not clean after proto generation or testing!"
              git status
              git --no-pager diff
              exit 1
          fi
